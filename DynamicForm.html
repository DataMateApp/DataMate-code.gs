<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label { display: block; margin: 10px 0 5px; }
    input, select { width: 100%; padding: 8px; margin-bottom: 10px; }
    button { padding: 10px; margin: 5px; }
    #message { color: green; margin-top: 10px; }
    .error { color: red; }
    #spinner { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    #spinner div { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: white; }
  </style>
</head>
<body>
  <form id="dynamicForm">
    <div id="formFields"></div>
    <button type="button" onclick="saveRecord()">Save</button>
    <button type="button" onclick="clearForm()">New Record</button>
    <button type="button" onclick="navigate('prev')">Previous</button>
    <button type="button" onclick="navigate('next')">Next</button>
    <button type="button" onclick="deleteRecord()">Delete</button>
    <button type="button" onclick="searchRecord()">Search</button>
  </form>
  <div id="message"></div>
  <div id="spinner"><div>Loading...</div></div>

  <script>
    let headers = [];
    let records = [];
    let currentIndex = -1;
    let isNewRecord = false; // Track add or edit mode

    google.script.run.withSuccessHandler(populateForm).getSheetInfo();
    google.script.run.withSuccessHandler(loadRecords).getVisibleRecords();

    function populateForm(headerData) {
      headers = headerData;
      const formFields = document.getElementById('formFields');
      formFields.innerHTML = headers.map(header => {
        if (header.name === 'ID') {
          return `<label for="${header.name}">${header.name}</label>
                  <input type="number" id="${header.name}" readonly>`;
        } else if (header.type === 'select') {
          return `<label for="${header.name}">${header.name} ${header.required ? '*' : ''}</label>
                  <select id="${header.name}" ${header.required ? 'required' : ''}>
                    <option value="">Select ${header.name}</option>
                    ${header.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                  </select>`;
        } else {
          return `<label for="${header.name}">${header.name} ${header.required ? '*' : ''}</label>
                  <input type="${header.type}" id="${header.name}" ${header.required ? 'required' : ''}>`;
        }
      }).join('');
    }

    function loadRecords(data) {
      records = data;
      if (records.length > 0) {
        currentIndex = 0;
        isNewRecord = false; // Set to edit mode for existing records
        displayRecord();
      }
    }

    function displayRecord() {
      isNewRecord = false; // Edit mode
      if (currentIndex >= 0 && currentIndex < records.length) {
        headers.forEach(header => {
          const field = document.getElementById(header.name);
          const value = records[currentIndex][header.name] || '';
          if (field.tagName === 'SELECT') {
            // Check if value exists in dropdown
            let exists = Array.from(field.options).some(opt => opt.value === value);
            if (!exists && value) {
              // Add it temporarily so it can be selected
              const opt = document.createElement('option');
              opt.value = value;
              opt.textContent = value;
              field.appendChild(opt);
            }
            field.value = value;
          } else {
            field.value = value;
          }
        });
      }
    }

    function saveRecord() {
      document.getElementById('spinner').style.display = 'block';
      const formData = {};
      headers.forEach(header => {
        formData[header.name] = document.getElementById(header.name).value.trim();
      });
      if (headers.some(header => header.required && !formData[header.name])) {
        showMessage('Please fill all required fields.', 'error');
        document.getElementById('spinner').style.display = 'none';
        return;
      }
      if (isNewRecord) {
        google.script.run.withSuccessHandler(result => onSave(result, null))
          .withFailureHandler(onError).addRecord(formData);
      } else {
        formData._rowNumber = currentIndex + 2; // +2 because currentIndex is 0-based and row 1 is headers
        google.script.run.withSuccessHandler(result => onSave(result, formData._rowNumber))
          .withFailureHandler(onError).updateRecord(formData);
      }
    }

    function deleteRecord() {
      document.getElementById('spinner').style.display = 'block';
      const id = document.getElementById('ID').value;
      if (id) {
        google.script.run.withSuccessHandler(onDelete).withFailureHandler(onError).deleteRecord(id);
      } else {
        showMessage('No record selected to delete.', 'error');
        document.getElementById('spinner').style.display = 'none';
      }
    }

    function clearForm(keepID = false) {
      isNewRecord = true; // New mode
      document.getElementById('dynamicForm').reset();
      headers.forEach(header => {
        if (keepID && header.name === 'ID') return;
        document.getElementById(header.name).value = '';
      });
      showMessage('Ready for new record.', '');
    }

    function navigate(direction) {
      if (records.length === 0) return;
      if (direction === 'prev' && currentIndex > 0) {
        currentIndex--;
      } else if (direction === 'next' && currentIndex < records.length - 1) {
        currentIndex++;
      }
      isNewRecord = false; // Set to edit mode when navigating
      displayRecord();
    }

    function searchRecord() {
      const id = prompt('Enter ID to search:');
      if (id) {
        document.getElementById('spinner').style.display = 'block';
        google.script.run.withSuccessHandler(record => {
          document.getElementById('spinner').style.display = 'none';
          if (record) {
            headers.forEach(header => {
              document.getElementById(header.name).value = record[header.name] || '';
            });
            isNewRecord = false; // Set to edit mode for found record
            showMessage('Record found.', '');
          } else {
            showMessage('Record not found or filtered out.', 'error');
          }
        }).withFailureHandler(err => {
          document.getElementById('spinner').style.display = 'none';
          onError(err);
        }).searchRecord(id);
      }
    }

    function onSave(result, existingID) {
      document.getElementById('spinner').style.display = 'none';
      if (result.status === 'success') {
        showMessage('Record saved successfully.', '');
        google.script.run.withSuccessHandler(data => {
          records = data;
          if (existingID) {
            const idx = records.findIndex(r => String(r.ID) === String(existingID));
            if (idx >= 0) {
              currentIndex = idx;
              isNewRecord = false;
              displayRecord();
            }
          } else {
            currentIndex = records.length - 1;
            isNewRecord = false;
            displayRecord();
          }
        }).getVisibleRecords();
      } else {
        showMessage(result.message || 'Error saving record.', 'error');
      }
    }

    function onDelete(result) {
      document.getElementById('spinner').style.display = 'none';
      showMessage('Record deleted successfully.', '');
      google.script.run.withSuccessHandler(loadRecords).getVisibleRecords();
      clearForm();
    }

    function onError(error) {
      document.getElementById('spinner').style.display = 'none';
      showMessage('Error: ' + error.message, 'error');
    }

    function showMessage(message, className) {
      const msgDiv = document.getElementById('message');
      msgDiv.textContent = message;
      msgDiv.className = className;
      setTimeout(() => msgDiv.textContent = '', 3000);
    }
  </script>
</body>
</html>
